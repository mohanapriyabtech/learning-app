{"version":3,"file":"admin-authentication.js","names":["_adminModel","require","_passport","_interopRequireDefault","_passportJwt","_responseHandler","_sessionModel","AdminAuthentication","_classCallCheck2","default","secretKey","process","env","SECRET_KEY","opts","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","secretOrKey","passport","use","JwtStrategy","_ref","_asyncToGenerator2","_regenerator","mark","_callee","jwtPayload","done","user","wrap","_callee$","_context","prev","next","Admin","findById","id","sent","abrupt","t0","stop","_x","_x2","apply","arguments","_createClass2","key","value","_check","_callee2","req","res","token","session","_callee2$","_context2","headers","authorization","Session","findOne","session_token","split","status","exec","responseHandler","errorResponse","authenticate","err","check","_x3","_x4","_x5","_default","exports"],"sources":["../../../../../src/modules/v1/admin/authentication/admin-authentication.js"],"sourcesContent":["import { Admin } from '../models/admin-model';\nimport passport from 'passport';\nimport { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';\nimport { responseHandler } from '../../../../utils/response-handler';\nimport { Session } from '../models/session-model';\n\nclass AdminAuthentication {\n    constructor() {\n        this.secretKey = process.env.SECRET_KEY;\n\n        // Configure Passport to use JWT strategy\n        const opts = {\n            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n            secretOrKey: this.secretKey,\n        };\n\n        passport.use('admin-jwt', new JwtStrategy(opts, async (jwtPayload, done) => {\n            try {\n                const user = await Admin.findById(jwtPayload.id);\n                if (user) {\n                    return done(null, user);\n                } else {\n                    return done(null, false);\n                    // or you could create a new account\n                }\n            } catch (err) {\n                return done(err, false);\n            }\n        }));\n    }\n\n    async check(req, res, next) {\n\n        const token = req.headers.authorization;\n        const session = await Session.findOne({ session_token: token.split(\" \")[1], status: 1 }).exec();\n\n        if (!session) {\n            return responseHandler.errorResponse(res, {}, \"Invalid or expired session token\", 401);\n        }\n\n        passport.authenticate('admin-jwt', { session: false }, (err, user) => {\n            if (err) {\n                return next(err);\n            }\n            if (!user) {\n                return responseHandler.errorResponse(res, {}, 'authentication failed', 401);\n            }\n\n            req.user = user;\n            next();\n        })(req, res, next);\n    }\n}\n\nexport default new AdminAuthentication();"],"mappings":"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"}